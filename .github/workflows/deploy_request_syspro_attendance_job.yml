name: Deploy `Request SysPro Attendance Job`
on:
  push:
    # branches:
    #   - master

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GCP_WORKLOAD_IDENTIFY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTIFY_PROVIDER }}
  GCP_SERVICE_ACCOUNT_MAIL_ADDRESS: ${{ secrets.GCP_SERVICE_ACCOUNT_MAIL_ADDRESS }}
  SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
  IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/test-image:${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - use: actions/checkout@v3
      - uses: docker/setup
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v0.4.0'
        with:
          workload_identity_provider: $GCP_WORKLOAD_IDENTIFY_PROVIDER
          service_account: $GCP_SERVICE_ACCOUNT_MAIL_ADDRESS

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v0'

      - name: 'Configure docker to use the cloud cli'
        run: gcloud auth configure-docker --quiet

      - name: 'Build'
        run: docker build -f request_syspro_attendance_job.Dockerfile -t $IMAGE .

      - name: 'Push the docker image'
        run: docker push $IMAGE

      - name: 'Deploy to Cloud Run'
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image $IMAGE \
            --project $GCP_PROJECT_ID \
            --region $GCP_REGION \
            --quiet
